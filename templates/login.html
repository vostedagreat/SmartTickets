<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | USIU Smart Tickets</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='login.css') }}">

    <script>
        function goToAdmin() {
           console.log("Redirecting to admin dashboard page...");  // Log message for debugging
           window.location.href = "/admin_dashboard"; 
       }
        function goToSignup() {
           console.log("Redirecting to signup page...");  // Log message for debugging
           window.location.href = "/signup";  // Redirect to the signup page
       }

   </script>
</head>

<body>
    <div class="main-content">
        <div class="image-area">
            <img id="login-image" src="{{ url_for('static', filename='images/login_image.png') }}" alt="login_image">
        </div>

        <div class="login-section">
            <h2 class="bluetext" id="usiu">USIU</h2>
            <h2 class="yellowtext" id="events">Events</h2>

            <h5>Login into your account</h5>
            <form id="loginForm">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" placeholder="Email" required>

                <br>

                <label for="password">Password</label>
                <input type="password" id="password" name="password" placeholder="Password" required>

                <br>
                <h5 class="bluetext" id="forgotpassword">Forgot Password?</h5>

                <button id="login" type="submit">Login Now</button>

                <div class="or-divider">OR</div>

                <button id="signup" type="button" onclick="goToSignup()">Sign Up Now</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { auth } from "/static/js/firebase-config.js";
        import { signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js";

        document.getElementById("loginForm").addEventListener("submit", async function(event) {
            event.preventDefault(); // Prevent page reload
            console.log("[DEBUG] Auth object:", auth);

            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            console.log("[DEBUG] Form data:", { email, password });

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log("[DEBUG] Login successful for user:", userCredential.user);

                fetch(`/get_user_role`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ uid: userCredential.user.uid })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.role === "student") {
                            window.location.href = "/client_dashboard";
                        } else if (data.role === "staff") {
                            window.location.href = "/admin_dashboard";
                        } else {
                            alert("Role not recognized. Please contact support.");
                        }
                    })
                    .catch(error => {
                        console.error("[ERROR] Failed to retrieve user role:", error);
                        alert("An error occurred while verifying your role. Please try again.");
                    });
            } catch (error) {
                console.error("[ERROR] Login failed:", error);
                switch (error.code) {
                    case "auth/wrong-password":
                        alert("Incorrect password. Please try again.");
                        break;
                    case "auth/user-not-found":
                        alert("No account found for this email.");
                        break;
                    default:
                        alert(`Login failed: ${error.message}`);
                }
            }
        });
    </script>
</body>