<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='admin_dashboard.css') }}">
    <script type="module">
        import { firebaseConfig } from "/static/js/firebase-config.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore.js";

        // Initialize Firebase using imported config
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        document.addEventListener("DOMContentLoaded", async function() {
            const newEventButton = document.getElementById("new_event");
            const eventModal = document.getElementById("eventmodal");
            const closeModalButton = document.getElementById("back");
            const eventsTable = document.getElementById("eventsTable");
            let editEventId = null; //Track the event being edited

            //Fetch and display events in the table
            async function fetchEvents() {
                eventsTable.innerHTML = ""; //Clear existing rows

                try {
                    const querySnapshot = await getDocs(collection(db, "events"));
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const row = document.createElement("tr");

                        row.innerHTML = `
                            <td>${data.eventName}</td>
                            <td>${data.date} ${data.startTime} - ${data.endTime}</td>
                            <td>${data.location}</td>
                            <td>${data.price}</td>
                            <td>
                                <button id="editbtn" class="edit-btn" data-id="${doc.id}">Edit</button>
                                <button id="deletebtn" class="delete-btn" data-id="${doc.id}">Delete</button>
                            </td>
                        `;

                        eventsTable.appendChild(row);
                    });

                    //Listeners for Edit and Delete buttons
                    document.querySelectorAll(".edit-btn").forEach(button => {
                        button.addEventListener("click", handleEditEvent);
                    });

                    document.querySelectorAll(".delete-btn").forEach(button => {
                        button.addEventListener("click", handleDeleteEvent);
                    });
                } catch (error) {
                    console.error("Error fetching events:", error);
                    alert("Failed to fetch events. Please try again.");
                }
            }

            //Editing events
            function handleEditEvent(event) {
                const eventId = event.target.getAttribute("data-id");

                getDoc(doc(db, "events", eventId)).then(docSnap => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById("event-name").value = data.eventName;
                        document.getElementById("event-description").value = data.description;
                        document.getElementById("loaction").value = data.location;
                        document.getElementById("date").value = data.date;
                        document.getElementById("price").value = data.price;
                        document.getElementById("start-time").value = data.startTime;
                        document.getElementById("end-time").value = data.endTime;

                        editEventId = eventId; //Track the event being edited
                        eventModal.style.display = "block"; //Show modal
                    }
                }).catch(error => {
                    console.error("Error fetching event:", error);
                    alert("Failed to fetch event details for editing.");
                });
            }

            //Deleting events
            async function handleDeleteEvent(event) {
                const eventId = event.target.getAttribute("data-id");

                if (confirm("Are you sure you want to delete this event?")) {
                    try {
                        await deleteDoc(doc(db, "events", eventId));
                        console.log("Event deleted successfully!");
                        alert("Event deleted successfully!");
                        await fetchEvents(); //Refresh the table
                    } catch (error) {
                        console.error("Error deleting event:", error);
                        alert("Failed to delete event. Please try again.");
                    }
                }
            }

            //Listener for Create or Update event
            document.getElementById("create-event").addEventListener("click", async function(event) {
                event.preventDefault();

                const eventName = document.getElementById("event-name").value;
                const description = document.getElementById("event-description").value;
                const location = document.getElementById("loaction").value;
                const date = document.getElementById("date").value;
                const price = document.getElementById("price").value;
                const startTime = document.getElementById("start-time").value;
                const endTime = document.getElementById("end-time").value;
                const file = document.getElementById("event-image").files[0];

                //Default placeholder image
                let imageUrl = "/static/images/default.png";

                try {
                    //Upload image if a file is provided
                    if (file) {
                        const formData = new FormData();
                        formData.append("eventImage", file);

                        const response = await fetch("/upload_image", {
                            method: "POST",
                            body: formData,
                        });

                        const result = await response.json();
                        if (response.ok) {
                            imageUrl = result.imageUrl; //Get uploaded image URL
                        } else {
                            console.error("Failed to upload image:", result.error);
                            alert("Image upload failed. Default image will be used.");
                        }
                    }

                    if (editEventId) {
                        //Update existing event
                        await updateDoc(doc(db, "events", editEventId), {
                            eventName: eventName,
                            description: description,
                            location: location,
                            date: date,
                            price: price,
                            startTime: startTime,
                            endTime: endTime,
                            imageUrl: imageUrl, //Add the image URL here
                        });
                        console.log("Event updated successfully!");
                        alert("Event updated successfully!");
                    } else {
                        //Create new event
                        const docRef = await addDoc(collection(db, "events"), {
                            eventName: eventName,
                            description: description,
                            location: location,
                            date: date,
                            price: price,
                            startTime: startTime,
                            endTime: endTime,
                            imageUrl: imageUrl, //Add the image URL here
                        });
                        console.log("Event added successfully with ID:", docRef.id);
                        messageContainer.textContent = "Event Has been created successfully!";
                        messageContainer.style.color = "green";
                        messageContainer.style.display = "block";
                    }

                    setTimeout(() => {
                        eventModal.style.display = "none"; //Close the modal
                     //Hide message after 3 seconds
                    }, 3000);
                    await fetchEvents();

                     //Refresh the table
                } catch (error) {
                    console.error("Error updating/creating event:", error);
                    alert("Failed to save event details.");
                }

                editEventId = null; //Reset edit tracking
            });

            //Listeners for opening and closing modal
            newEventButton.addEventListener("click", function() {
                editEventId = null; // Reset in case of a new event
                eventModal.style.display = "block";
            });

            closeModalButton.addEventListener("click", function() {
                eventModal.style.display = "none";
            });

            window.addEventListener("click", function(event) {
                if (event.target === eventModal) {
                    eventModal.style.display = "none";
                }
            });

            //Fetch and display events on page load
            await fetchEvents();
        });
        
    </script>

</head>

<body>
    
    <div class="container">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">

            <ul>
                <li><a href="/admin_dashboard" class="active"><img src="{{ url_for('static', filename='images/event.png') }}" class="icon-img"> <span class="text">Events</span></a></li>
                <li><a href="/admin_qrcode"><img src="{{ url_for('static', filename='images/qr-code.png') }}" class="icon-img"> <span class="text">QR Code</span></a></li>
                <li><a href="/admin_checkin"><img src="{{ url_for('static', filename='images/checkmark.png') }}" class="icon-img"> <span class="text">Event Check In</span></a></li>
                <li><a href="/admin_feedback"><img src="{{ url_for('static', filename='images/star.png') }}" class="icon-img"> <span class="text">Event Feedback</span></a></li>
            </ul>

            <button id="new_event" class="btn">+ New Event</button>
        </nav>
    </div>

    <div class="main-content">
        <h1>Events</h1>
        <p>Manage your Events</p>

        <div class="eventDetails">
            <table>
                <thead>
                    <tr>
                        <th>Event</th>
                        <th>Date & Time</th>
                        <th>Location</th>
                        <th>Ticket Price</th>
                        <th>Action</th>
                    </tr>
                </thead>

                <tbody id="eventsTable"></tbody>
                   
            </table>
        </div>

        <div class="modal" id="eventmodal">
            <div class="modal-content">
        
                <div class="modal-header"> 
                    <img src="{{ url_for('static', filename='images/back.png') }}" id="back">        
                    <h2>USIU Events</h2>
                </div>

                <form>
                    <h3>Create Event</h3>
                    
                    <label for="event_name">Event Name</label>
                    <input id="event-name" type="text" placeholder="Event Name">

                    <label for="description">Event Description</label>
                    <input id="event-description" type="text" placeholder="About the Event">
                    
                    <label for="location">Location</label>
                    <input id="loaction" type="text" placeholder="Location">

                    <label for="date">Date</label>
                    <input id="date" type="date" placeholder="Event Date">

                    <label for="price">Price</label>
                    <input id="price" type="number" default="Free" placeholder="Ticket Price">

                    <label for="start_time">Start Time</label>
                    <input id="start-time" type="time" placeholder="Start Time">

                    <label for="endtime">End Time</label>
                    <input id="end-time" type="time" placeholder="End Time">

                    <label for="event-image">Event Image/Logo</label>
                    <input id="event-image" type="file" accept="image/*">

                    <button id="create-event" type="submit">Create Event</button>

                </form>
                <p id="messageContainer" style="display: none; color: green;"></p>
                


            </div>
        </div>

    </div>
   
</body>
</html>
