<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USIU Events</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='client_dashboard.css') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { firebaseConfig } from "/static/js/firebase-config.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore.js";
    
        //Initialize Firebase using imported config
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
    
        document.addEventListener("DOMContentLoaded", async function () {
            const headerContent = document.querySelector(".header-content");
            const eventsContainer = document.querySelector(".grid");
            const searchLocation = document.querySelector(".search-location");
            const searchDate = document.querySelector(".search-date");
    
            //Fetch and display the featured event in the header
            async function fetchFeaturedEvent() {
                try {
                    const querySnapshot = await getDocs(collection(db, "events"));
                    const featuredEvent = querySnapshot.docs[0]?.data(); //Pick the first event
    
                    if (featuredEvent) {
                        headerContent.innerHTML = `
                            <h1 class="text-6xl font-bold">${featuredEvent.eventName}</h1>
                            <p class="mt-4 text-lg">${featuredEvent.description}</p>
                            <button class="mt-4 bg-pink-500 px-6 py-2 text-white rounded-full">Get Ticket</button>
                        `;
                    } else {
                        // Handle no event case
                        headerContent.innerHTML = `
                            <h1 class="text-6xl font-bold">No Events Found</h1>
                            <p class="mt-4 text-lg">Please check back later!</p>
                            <button class="mt-4 bg-pink-500 px-6 py-2 text-white rounded-full disabled">Unavailable</button>
                        `;
                    }
                } catch (error) {
                    console.error("Error fetching featured event:", error);
                    headerContent.innerHTML = `
                        <h1 class="text-6xl font-bold">Featured Event</h1>
                        <p class="mt-4 text-lg">Details will be displayed soon.</p>
                        <button class="mt-4 bg-pink-500 px-6 py-2 text-white rounded-full disabled">Unavailable</button>
                    `;
                }
            }
    
            //Fetch and display unique locations in the dropdown
            async function fetchLocations() {
                try {
                    const querySnapshot = await getDocs(collection(db, "events"));
                    const locationSet = new Set(); //Set to avoid duplicates
    
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        if (data.location) {
                            locationSet.add(data.location); //Add location to the Set
                        }
                    });
    
                    //Clear and populate dropdown dynamically
                    searchLocation.innerHTML = `<option value="">All Locations</option>`;
                    locationSet.forEach((location) => {
                        const option = document.createElement("option");
                        option.value = location;
                        option.textContent = location;
                        searchLocation.appendChild(option);
                    });
                } catch (error) {
                    console.error("Error fetching locations:", error);
                    alert("Failed to load location options. Please try again.");
                }
            }
    
            //Fetch and display filtered events
            async function fetchFilteredEvents(location = "", date = "") {
                try {
                    const querySnapshot = await getDocs(collection(db, "events"));
                    eventsContainer.innerHTML = ""; //Clear existing events
    
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
    
                        //Apply filters
                        if (
                            (!location || data.location === location) && //Match exact location
                            (!date || data.date === date) //Match exact date
                        ) {
                            const eventCard = document.createElement("div");
                            eventCard.className = "bg-white p-4 shadow rounded-lg";
    
                            eventCard.innerHTML = `
                                <img src="${data.imageUrl}" class="w-full rounded" alt="${data.eventName}">
                                <h3 class="mt-3 font-bold">${data.eventName}</h3>
                                <p class="text-sm mt-2">${data.description}</p>
                                <p class="text-sm font-semibold mt-1">${data.date} ${data.startTime} - ${data.endTime}</p>
                            `;
    
                            eventsContainer.appendChild(eventCard);
                        }
                    });
                } catch (error) {
                    console.error("Error fetching events:", error);
                    alert("Failed to load events. Please try again later.");
                }
            }
    
            //Event listeners for search filters
            searchLocation.addEventListener("change", function () {
                fetchFilteredEvents(searchLocation.value, searchDate.value);
            });
            searchDate.addEventListener("change", function () {
                fetchFilteredEvents(searchLocation.value, searchDate.value);
            });
    
            //Fetch featured event, locations, and events on page load
            await fetchFeaturedEvent();
            await fetchLocations();
            await fetchFilteredEvents();
        });
    </script>
</head>

<body >
    <!-- Header Section -->
    <header class="relative bg-black text-white h-[60vh] flex items-center justify-center">
        <div class="absolute inset-0 bg-[url('user.png')] bg-cover bg-center opacity-80"></div>
       
        <div class="header-content">
            <h1 class="text-6xl font-bold">Featured Event</h1>
            <p class="mt-4 text-lg">Details will be displayed soon.</p>
            <button class="mt-4 bg-pink-500 px-6 py-2 text-white rounded-full disabled">Unavailable</button>
        </div>

        <div class="profile-container">
            <img id="profile-img" src="{{ url_for('static', filename='images/main-menu.png') }}" alt="User Profile">
            <div id="profile-menu" >
                <ul>
                    <li>
                        <a href="/profile" style="display: flex; align-items: center;">
                            <img class="list-image" src="{{ url_for('static', filename='images/user.png') }}" alt="Profile">
                            <span>Profile</span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="/client_purchases" style="display: flex; align-items: center;">
                            <img class="list-image" src="{{ url_for('static', filename='images/shopping-bag.png') }}" alt="Purchases">
                            <span>Purchases</span>
                        </a>
                    </li>
                    <li><img class="list-image" src="{{ url_for('static', filename='images/logout.png') }}" alt="Logout">Logout</li>
                </ul>
            </div>
        </div>
    </header>
    
    <!-- Search Bar -->
    <div class="container mx-auto px-5 mt-6">
        <div class="bg-indigo-800 p-5 rounded-lg flex flex-wrap gap-4 text-white">
            <select class="search-location p-3 bg-white text-black rounded w-2/5">
                <!-- Options will be dynamically populated -->
                <option value="">All Locations</option>
            </select>
            <input type="date" class="search-date p-3 bg-white text-black rounded w-2/5">
        </div>
    </div>
    
    <!-- Upcoming Events -->
    <section class="container mx-auto px-5 mt-8">
        <h2 class="text-3xl font-bold">Upcoming Events</h2>
        <div class="grid md:grid-cols-3 gap-6 mt-6">
            <!-- Event cards will be dynamically populated here -->
        </div>
    </section>
    
    <!-- Footer -->
    <footer class="bg-gray-900 text-white p-6 mt-10">
        <div class="container mx-auto text-center">
            <p>Â© USIU Events 2024 | All rights reserved</p>
        </div>
    </footer>
</body>
</html>
